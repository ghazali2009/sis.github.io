<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Head Content -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS Construction Management System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f4f4f4;
            font-family: 'Roboto', sans-serif;
        }
        .container {
            margin-top: 20px;
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .chart-container {
            margin-top: 20px;
            height: 400px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .btn-custom {
            background-color: #0d6efd;
            color: white;
        }
        .btn-custom:hover {
            background-color: #0b5ed7;
        }
        .category-tab { /* Custom class for category tabs */ }
        .period-selection {
            margin-top: 15px;
        }
        .dark-mode {
            background-color: #121212 !important;
            color: #e0e0e0 !important;
        }
        .dark-mode .container {
            background-color: #1e1e1e;
        }
        .dark-mode .nav-tabs .nav-link {
            color: #e0e0e0;
        }
        .dark-mode .nav-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }
        .dark-mode .table {
            color: #e0e0e0;
        }
        .search-bar {
            margin-top: 15px;
        }
        .form-tooltip {
            cursor: pointer;
        }
        /* Tooltip styling */
        .tooltip-inner {
            max-width: 200px;
            padding: 8px;
            color: #fff;
            text-align: center;
            background-color: #000;
            border-radius: 4px;
        }
        /* Login Styles */
        #loginContainer {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .login-button {
            background-color: #0d6efd;
            color: white;
            width: 100%;
        }
        .login-button:hover {
            background-color: #0b5ed7;
        }
        /* Summary Table */
        .summary-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .summary-table th {
            background-color: #0d6efd;
            color: white;
        }
        /* Align Export/Import Buttons */
        .export-import-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        /* Toasts */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        /* Advanced Search Styles */
        .advanced-search {
            margin-top: 15px;
            display: none;
        }
        .pivot-table-container {
            margin-top: 20px;
        }
        .kpi-card {
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            flex: 1;
        }
        .kpi-card h3 {
            margin-bottom: 0;
        }
        .kpi-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        .quick-select {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer">
        <!-- Toasts will be dynamically inserted here -->
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <!-- Modal content -->
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div class="modal fade" id="passwordResetModal" tabindex="-1" aria-labelledby="passwordResetModalLabel" aria-hidden="true">
        <!-- Modal content -->
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordResetModalLabel">Reset User Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="passwordResetForm">
                        <div class="mb-3">
                            <label for="resetUsername" class="form-label">Select User:</label>
                            <select id="resetUsername" class="form-select" required>
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password:</label>
                            <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password:</label>
                            <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitPasswordResetButton">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Container -->
    <div id="loginContainer">
        <h2 class="text-center">Login</h2>
        <div class="form-group mt-4">
            <label for="loginUsername">Username:</label>
            <input type="text" id="loginUsername" class="form-control" placeholder="Enter username" aria-label="Username">
        </div>
        <div class="form-group mt-3">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" aria-label="Password">
        </div>
        <button class="btn login-button mt-4" id="loginButton" aria-label="Login">Login</button>
    </div>
        <!-- Main Content -->
        <div class="container" id="mainContent" style="display: none;" role="main">
            <h1 class="text-center">SIS Construction Management System</h1>
            
            <!-- Button Group -->
            <div class="button-group">
                <button class="btn btn-secondary toggle-darkmode" id="toggleDarkModeButton" aria-label="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn btn-secondary logout-button" id="logoutButton" aria-label="Logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <!-- Export Buttons for Data Entry Users -->
                <button class="btn btn-primary" id="exportDataEntryExpensesButton" aria-label="Export Expenses">
                    <i class="fas fa-file-excel"></i> Export Expenses
                </button>
                <button class="btn btn-primary" id="exportDataEntryFundsButton" aria-label="Export Funds">
                    <i class="fas fa-file-excel"></i> Export Funds
                </button>
                <!-- Admin-Only Buttons -->
                <button class="btn btn-success backup-button admin-only" id="backupButton" aria-label="Backup Database">
                    <i class="fas fa-download"></i> Backup Database
                </button>
                <button class="btn btn-warning restore-button admin-only" id="restoreButton" aria-label="Restore Database">
                    <i class="fas fa-upload"></i> Restore Database
                </button>
                <button class="btn btn-danger reset-button admin-only" id="resetButton" aria-label="Reset Data">
                    <i class="fas fa-sync-alt"></i> Reset Data
                </button>
                <button class="btn btn-info reset-password-button admin-only" id="resetPasswordButton" aria-label="Reset Password">
                    <i class="fas fa-key"></i> Reset Password
                </button>
            </div>
            
            <input type="file" id="restoreFileInput" style="display: none;" accept=".xlsx, .xls" aria-label="Restore File Input">
            
            <!-- Expense Entry Section -->
            <div class="form-group row">
                <h3>Expense Entry</h3>
                <div class="col-md-3 position-relative">
                    <input type="text" id="description" class="form-control" placeholder="Description" aria-label="Description">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Enter a brief description"></i>
                </div>
                <div class="col-md-2 position-relative">
                    <input type="number" id="amount" class="form-control" placeholder="Amount (Rs.)" aria-label="Amount">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Enter the amount in Rs."></i>
                </div>
                <div class="col-md-2 position-relative">
                    <input type="date" id="date" class="form-control" aria-label="Date">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Select the date of the expense"></i>
                </div>
                <div class="col-md-2 position-relative">
                    <select id="category" class="form-control" aria-label="Category">
                        <!-- Dynamic categories will be added here -->
                    </select>
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Select a category"></i>
                </div>
                <div class="col-md-3 position-relative">
                    <select id="subcategory" class="form-control" aria-label="Subcategory">
                        <option value="">Select Subcategory</option>
                    </select>
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Select a subcategory"></i>
                </div>
            </div>
            <div class="form-group row mt-3">
                <div class="col-md-3 position-relative">
                    <input type="text" id="newCategory" class="form-control" placeholder="New Category" aria-label="New Category">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Add a new category"></i>
                </div>
                <div class="col-md-3 position-relative">
                    <input type="text" id="newSubcategory" class="form-control" placeholder="New Subcategory" aria-label="New Subcategory">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Add a new subcategory"></i>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-custom w-100" id="addCategoryButton" aria-label="Add Category"><i class="fas fa-plus-circle"></i> Add Category</button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-custom w-100" id="addSubcategoryButton" aria-label="Add Subcategory"><i class="fas fa-plus-circle"></i> Add Subcategory</button>
                </div>
            </div>
            <div class="form-group row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-custom w-100" id="addExpenseButton" aria-label="Add Expense"><i class="fas fa-plus"></i> Add Expense</button>
                </div>
            </div>
            
            <!-- Export/Import Buttons for Expenses (Admin Only) -->
            <div class="export-import-buttons admin-only">
                <button class="btn btn-custom" id="exportExpensesButton" aria-label="Export Expenses to Excel"><i class="fas fa-file-excel"></i> Export Expenses to Excel</button>
                <button class="btn btn-custom" id="importExpensesButton" aria-label="Import Expenses from Excel"><i class="fas fa-file-import"></i> Import Expenses from Excel</button>
                <input type="file" id="fileInput" style="display: none;" accept=".xlsx, .xls" aria-label="File Input">
            </div>
            
            <!-- Funds Entry Section -->
            <div class="form-group row mt-4">
                <h3>Funds Entry</h3>
                <div class="col-md-3 position-relative">
                    <input type="text" id="fundsDescription" class="form-control" placeholder="Description" aria-label="Description">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Enter a brief description"></i>
                </div>
                <div class="col-md-2 position-relative">
                    <input type="number" id="fundsAmount" class="form-control" placeholder="Amount (Rs.)" aria-label="Amount">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Enter the amount in Rs."></i>
                </div>
                <div class="col-md-2 position-relative">
                    <input type="date" id="fundsDate" class="form-control" aria-label="Date">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Select the date of the funds"></i>
                </div>
                <div class="col-md-2 position-relative">
                    <select id="fundsCategory" class="form-control" aria-label="Category">
                        <!-- Funds categories will be populated here -->
                    </select>
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Select a category"></i>
                </div>
                <div class="col-md-3 position-relative">
                    <select id="fundsSubcategory" class="form-control" aria-label="Subcategory">
                        <option value="">Select Subcategory</option>
                    </select>
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Select a subcategory"></i>
                </div>
            </div>
            <div class="form-group row mt-3">
                <div class="col-md-3 position-relative">
                    <input type="text" id="newFundsCategory" class="form-control" placeholder="New Category" aria-label="New Category">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Add a new funds category"></i>
                </div>
                <div class="col-md-3 position-relative">
                    <input type="text" id="newFundsSubcategory" class="form-control" placeholder="New Subcategory" aria-label="New Subcategory">
                    <i class="fas fa-info-circle form-tooltip" data-bs-toggle="tooltip" data-bs-plaCenemt="top" title="Add a new subcategory"></i>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-custom w-100" id="addFundsCategoryButton" aria-label="Add Funds Category"><i class="fas fa-plus-circle"></i> Add Funds Category</button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-custom w-100" id="addFundsSubcategoryButton" aria-label="Add Funds Subcategory"><i class="fas fa-plus-circle"></i> Add Funds Subcategory</button>
                </div>
            </div>
            <div class="form-group row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-custom w-100" id="addFundsButton" aria-label="Add Funds"><i class="fas fa-plus"></i> Add Funds</button>
                </div>
            </div>
            
            <!-- Export/Import Buttons for Funds (Admin Only) -->
            <div class="export-import-buttons admin-only">
                <button class="btn btn-custom" id="exportFundsButton" aria-label="Export Funds to Excel"><i class="fas fa-file-excel"></i> Export Funds to Excel</button>
                <button class="btn btn-custom" id="importFundsButton" aria-label="Import Funds from Excel"><i class="fas fa-file-import"></i> Import Funds from Excel</button>
                <input type="file" id="fundsFileInput" style="display: none;" accept=".xlsx, .xls" aria-label="Funds File Input">
            </div>
            
            <!-- Summary Section -->
            <table class="summary-table" id="summarySection">
                <thead>
                    <tr>
                        <th>Funds Summary</th>
                        <th>Expense Summary</th>
                        <th>Net Balance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Rs. <span id="totalFunds">0.00</span></td>
                        <td>Rs. <span id="total">0.00</span></td>
                        <td>Rs. <span id="netBalance">0.00</span></td>
                    </tr>
                </tbody>
            </table>
            
            <!-- KPI Cards -->
            <div class="kpi-container">
                <div class="kpi-card">
                    <h3>Total Expenses</h3>
                    <p>Rs. <span id="kpiTotalExpenses">0.00</span></p>
                </div>
                <div class="kpi-card">
                    <h3>Total Funds</h3>
                    <p>Rs. <span id="kpiTotalFunds">0.00</span></p>
                </div>
                <div class="kpi-card">
                    <h3>Net Balance</h3>
                    <p>Rs. <span id="kpiNetBalance">0.00</span></p>
                </div>
            </div>
            
            <!-- Advanced Search -->
            <div class="advanced-search" id="advancedSearch">
                <div class="row">
                    <div class="col-md-3">
                        <label for="searchDescription">Description:</label>
                        <input type="text" id="searchDescription" class="form-control" placeholder="Search by description">
                    </div>
                    <div class="col-md-3">
                        <label for="searchCategory">Category:</label>
                        <select id="searchCategory" class="form-control">
                            <option value="">All Categories</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchSubcategory">Subcategory:</label>
                        <select id="searchSubcategory" class="form-control">
                            <option value="">All Subcategories</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchAmount">Amount Range:</label>
                        <input type="text" id="searchAmount" class="form-control" placeholder="e.g., 1000-5000">
                    </div>
                    <div class="col-md-12 text-end mt-2">
                        <button class="btn btn-primary" id="applyAdvancedSearch">Apply Filters</button>
                    </div>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="search-bar row">
                <div class="col-md-6">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search..." aria-label="Search">
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-secondary" id="toggleAdvancedSearch">Advanced Search</button>
                </div>
            </div>
            
            <!-- Quick Select Periods -->
            <div class="row quick-select">
                <div class="col-md-12">
                    <button class="btn btn-outline-primary" onclick="App.setQuickSelectPeriod('today')">Today</button>
                    <button class="btn btn-outline-primary" onclick="App.setQuickSelectPeriod('thisWeek')">This Week</button>
                    <button class="btn btn-outline-primary" onclick="App.setQuickSelectPeriod('thisMonth')">This Month</button>
                    <button class="btn btn-outline-primary" onclick="App.setQuickSelectPeriod('lastMonth')">Last Month</button>
                    <button class="btn btn-outline-primary" onclick="App.setQuickSelectPeriod('thisYear')">This Year</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <ul class="nav nav-tabs mt-3" id="mainTabs" role="tablist">
                <!-- Main tabs -->
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="App.showMainTab('expenseDashboard', this)" role="tab" aria-selected="true">Expense Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="App.showMainTab('fundsDashboard', this)" role="tab" aria-selected="false">Funds Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="App.showMainTab('balanceStatement', this)" role="tab" aria-selected="false">Balance Statement</a>
                </li>
            </ul>
            
            <!-- Sub Tabs -->
            <ul class="nav nav-tabs mt-3" id="subTabs" role="tablist">
                <!-- Sub tabs will be added here -->
            </ul>
            
            <!-- Period Selection -->
            <div class="row period-selection" id="periodSelection" style="display: none;">
                <div class="col-md-3">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" class="form-control" onchange="App.updateReport()" aria-label="Start Date">
                </div>
                <div class="col-md-3">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" class="form-control" onchange="App.updateReport()" aria-label="End Date">
                </div>
                <div class="col-md-3">
                    <label for="groupBy">Group By:</label>
                    <select id="groupBy" class="form-control" onchange="App.updateReport()">
                        <option value="Daily">Daily</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Yearly">Yearly</option>
                        <option value="Category">Category</option>
                        <option value="Subcategory">Subcategory</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="chartType">Chart Type:</label>
                    <select id="chartType" class="form-control" onchange="App.updateReport()">
                        <option value="Bar">Bar Chart</option>
                        <option value="Line">Line Chart</option>
                        <option value="Pie">Pie Chart</option>
                    </select>
                </div>
            </div>
            
            <!-- Content Areas -->
            <div id="expenseDashboardContent" class="mt-3">
                <div class="chart-container">
                    <canvas id="expenseDistribution" class="chart" aria-label="Expense Distribution Chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyExpensesChart" class="chart" aria-label="Monthly Expenses Chart"></canvas>
                </div>
                <!-- Pivot Table -->
                <div class="pivot-table-container" id="expensePivotTable"></div>
            </div>
            
            <div id="fundsDashboardContent" class="mt-3" style="display: none;">
                <div class="chart-container">
                    <canvas id="fundsDistribution" class="chart" aria-label="Funds Distribution Chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyFundsChart" class="chart" aria-label="Monthly Funds Chart"></canvas>
                </div>
                <!-- Pivot Table -->
                <div class="pivot-table-container" id="fundsPivotTable"></div>
            </div>
            
            <div id="balanceStatementContent" class="mt-3" style="display: none;">
                <!-- New Period Selection for Balance Statement -->
                <div class="row period-selection" id="balanceStatementPeriodSelection">
                    <div class="col-md-3">
                        <label for="balanceStatementPeriod">Group By:</label>
                        <select id="balanceStatementPeriod" class="form-control" onchange="App.updateBalanceStatementReport()">
                            <option value="Monthly">Monthly</option>
                            <option value="Daily">Daily</option>
                            <option value="Yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="balanceStatementChart" class="chart" aria-label="Balance Statement Chart"></canvas>
                </div>
                <div id="reportContent" class="mt-3">
                    <h2 id="reportTitle">Balance Statement Report</h2>
                    <div id="groupedReports">
                        <!-- Grouped reports will be inserted here -->
                    </div>
                    <button class="btn btn-primary admin-only" onclick="App.generatePDF()" aria-label="Download PDF Report"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
                </div>
            </div>
            
            <div id="reportContentSub" class="mt-3" style="display: none;">
                <h2 id="reportTitleSub"></h2>
                <div id="groupedReportsSub">
                    <!-- Grouped reports will be inserted here -->
                </div>
                <button class="btn btn-primary admin-only" onclick="App.generatePDFSub()" aria-label="Download PDF Report"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
            </div>
        </div>
        <!-- External JavaScript Libraries -->
        <!-- Include necessary JS libraries -->
        <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- For pivot table functionality -->
        <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.css">
        <!-- Bootstrap Bundle with Popper.js -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Font Awesome JS -->
        <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
        
        <!-- Application JavaScript -->
        <script>
            const App = (function() {
                // Application State
                let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                let categories = JSON.parse(localStorage.getItem('categories')) || [
                    'Bricks', 'Sand', 'Crush', 'Steel', 'Cenemt', 'Gravel',
                    'Bajjar', 'Labour', 'Contractor', 'Electrical', 'Plumbing',
                    'Hardwear items', 'Paint', 'Consultant fee', 'Fule',
                    'Tiles', 'Windows and doors', 'Plantation', 'Loans Out', 'Misleanious'
                ];
                let subcategories = JSON.parse(localStorage.getItem('subcategories')) || {};
                let funds = JSON.parse(localStorage.getItem('funds')) || [];
                let fundsCategories = JSON.parse(localStorage.getItem('fundsCategories')) || [
                    'Loans Paidback', 'Gift', 'Seed money'
                ];
                let fundsSubcategories = JSON.parse(localStorage.getItem('fundsSubcategories')) || {};
                let users = JSON.parse(localStorage.getItem('users')) || [
                    { username: 'admin', password: 'password123', role: 'admin' },
                    { username: 'dataentry', password: 'data123', role: 'dataentry' }
                ];
                let currentMainTab = 'expenseDashboard';
                let currentSubTab = '';
                let darkMode = false;
                let sessionId = '';
                let editingEntry = null;

                // Cached DOM Elements
                const loginContainer = document.getElementById('loginContainer');
                const mainContent = document.getElementById('mainContent');
                const loginButton = document.getElementById('loginButton');
                const logoutButton = document.getElementById('logoutButton');
                const toggleDarkModeButton = document.getElementById('toggleDarkModeButton');
                const addCategoryButton = document.getElementById('addCategoryButton');
                const addSubcategoryButton = document.getElementById('addSubcategoryButton');
                const addFundsCategoryButton = document.getElementById('addFundsCategoryButton');
                const addFundsSubcategoryButton = document.getElementById('addFundsSubcategoryButton');
                const addExpenseButton = document.getElementById('addExpenseButton');
                const addFundsButton = document.getElementById('addFundsButton');
                const exportExpensesButton = document.getElementById('exportExpensesButton');
                const importExpensesButton = document.getElementById('importExpensesButton');
                const fileInput = document.getElementById('fileInput');
                const exportFundsButton = document.getElementById('exportFundsButton');
                const importFundsButton = document.getElementById('importFundsButton');
                const fundsFileInput = document.getElementById('fundsFileInput');
                const backupButton = document.getElementById('backupButton');
                const restoreButton = document.getElementById('restoreButton');
                const restoreFileInput = document.getElementById('restoreFileInput');
                const resetButton = document.getElementById('resetButton');
                const resetPasswordButton = document.getElementById('resetPasswordButton');
                const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                const confirmationModalBody = document.getElementById('confirmationModalBody');
                const confirmActionButton = document.getElementById('confirmActionButton');
                const passwordResetModal = new bootstrap.Modal(document.getElementById('passwordResetModal'));
                const resetUsernameSelect = document.getElementById('resetUsername');
                const submitPasswordResetButton = document.getElementById('submitPasswordResetButton');
                const newPasswordInput = document.getElementById('newPassword');
                const confirmPasswordInput = document.getElementById('confirmPassword');
                const toastContainer = document.getElementById('toastContainer');

                // Cached Export Buttons for Data Entry Users
                const exportDataEntryExpensesButton = document.getElementById('exportDataEntryExpensesButton');
                const exportDataEntryFundsButton = document.getElementById('exportDataEntryFundsButton');

                // Advanced Search Elements
                const toggleAdvancedSearchButton = document.getElementById('toggleAdvancedSearch');
                const advancedSearchDiv = document.getElementById('advancedSearch');
                const applyAdvancedSearchButton = document.getElementById('applyAdvancedSearch');

                // Event Listeners
                document.addEventListener('DOMContentLoaded', () => {
                    checkLoginStatus();
                    initializeTooltips();
                    initializeEventListeners();
                });

                function initializeEventListeners() {
                    loginButton.addEventListener('click', login);
                    logoutButton.addEventListener('click', logout);
                    toggleDarkModeButton.addEventListener('click', toggleDarkMode);
                    addCategoryButton.addEventListener('click', addCategory);
                    addSubcategoryButton.addEventListener('click', addSubcategory);
                    addFundsCategoryButton.addEventListener('click', addFundsCategory);
                    addFundsSubcategoryButton.addEventListener('click', addFundsSubcategory);
                    addExpenseButton.addEventListener('click', addExpense);
                    addFundsButton.addEventListener('click', addFunds);
                    exportExpensesButton.addEventListener('click', exportExpensesToExcel);
                    importExpensesButton.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', importFromExcel);
                    exportFundsButton.addEventListener('click', exportFundsToExcel);
                    importFundsButton.addEventListener('click', () => fundsFileInput.click());
                    fundsFileInput.addEventListener('change', importFundsFromExcel);
                    backupButton.addEventListener('click', backupDatabase);
                    restoreButton.addEventListener('click', () => restoreFileInput.click());
                    restoreFileInput.addEventListener('change', restoreDatabase);
                    resetButton.addEventListener('click', confirmReset);
                    confirmActionButton.addEventListener('click', performConfirmedAction);

                    // Export Buttons for Data Entry Users
                    exportDataEntryExpensesButton.addEventListener('click', exportExpensesToExcel);
                    exportDataEntryFundsButton.addEventListener('click', exportFundsToExcel);

                    // Password Reset Button
                    resetPasswordButton.addEventListener('click', openPasswordResetModal);
                    submitPasswordResetButton.addEventListener('click', handlePasswordReset);

                    // Advanced Search
                    toggleAdvancedSearchButton.addEventListener('click', toggleAdvancedSearch);
                    applyAdvancedSearchButton.addEventListener('click', performAdvancedSearch);

                    // Search Input
                    document.getElementById('searchInput').addEventListener('keyup', updateReport);

                    // Event Listeners for Date Pickers
                    document.getElementById('startDate').addEventListener('change', updateReport);
                    document.getElementById('endDate').addEventListener('change', updateReport);

                    // Group By and Chart Type Selectors
                    document.getElementById('groupBy').addEventListener('change', updateReport);
                    document.getElementById('chartType').addEventListener('change', updateReport);
                }

                function checkLoginStatus() {
                    const loggedIn = sessionStorage.getItem('loggedIn');
                    if (loggedIn === 'true') {
                        loginContainer.style.display = 'none';
                        mainContent.style.display = 'block';
                        const userRole = sessionStorage.getItem('userRole');
                        if (userRole === 'dataentry') {
                            sessionId = generateSessionId();
                            sessionStorage.setItem('sessionId', sessionId);
                        }
                        initializeApp();
                    } else {
                        loginContainer.style.display = 'block';
                        mainContent.style.display = 'none';
                    }
                }

                function login() {
                    const username = document.getElementById('loginUsername').value.trim();
                    const password = document.getElementById('loginPassword').value.trim();
                    const user = users.find(u => u.username === username && u.password === password);
                    if (user) {
                        sessionStorage.setItem('loggedIn', 'true');
                        sessionStorage.setItem('userRole', user.role);
                        showToast('Login successful!', 'success');
                        checkLoginStatus();
                    } else {
                        showToast('Invalid username or password.', 'danger');
                    }
                }

                function logout() {
                    sessionStorage.setItem('loggedIn', 'false');
                    sessionStorage.removeItem('userRole');
                    sessionStorage.removeItem('sessionId');
                    showToast('Logged out successfully.', 'info');
                    checkLoginStatus();
                }

                function initializeApp() {
                    updateCategoryOptions();
                    updateFundsCategoryOptions();
                    updateTabs();
                    updateExpenseSummary();
                    updateFundsSummary();
                    updateExpenseCharts();
                    updateFundsCharts();
                    updateBalanceStatementChart();
                    loadDarkModePreference();
                    adjustUIBasedOnRole();
                    populateAdvancedSearchOptions();
                    updateKPIValues();
                }

                function adjustUIBasedOnRole() {
                    const userRole = sessionStorage.getItem('userRole');
                    if (userRole === 'dataentry') {
                        sessionId = sessionStorage.getItem('sessionId');
                        // Hide admin-only elements
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                        // Hide tabs
                        document.getElementById('mainTabs').style.display = 'none';
                        document.getElementById('subTabs').style.display = 'none';
                        document.getElementById('periodSelection').style.display = 'none';
                        // Hide reports and charts
                        document.getElementById('expenseDashboardContent').style.display = 'none';
                        document.getElementById('fundsDashboardContent').style.display = 'none';
                        document.getElementById('balanceStatementContent').style.display = 'none';
                        document.getElementById('reportContentSub').style.display = 'none';
                        // Hide Summary Section
                        document.getElementById('summarySection').style.display = 'none';
                        // Show export buttons for dataentry users
                        exportDataEntryExpensesButton.style.display = 'inline-block';
                        exportDataEntryFundsButton.style.display = 'inline-block';
                        // Hide export buttons for admin users
                        exportExpensesButton.style.display = 'none';
                        exportFundsButton.style.display = 'none';
                    } else if (userRole === 'admin') {
                        // Show admin-only elements
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                        // Show tabs
                        document.getElementById('mainTabs').style.display = 'flex';
                        // Show Summary Section
                        document.getElementById('summarySection').style.display = 'table';
                        // Hide export buttons for dataentry users
                        exportDataEntryExpensesButton.style.display = 'none';
                        exportDataEntryFundsButton.style.display = 'none';
                        // Show export buttons for admin users
                        exportExpensesButton.style.display = 'inline-block';
                        exportFundsButton.style.display = 'inline-block';
                    }
                }

                function initializeTooltips() {
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                }

                function toggleDarkMode() {
                    darkMode = !darkMode;
                    if (darkMode) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('darkMode', 'enabled');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('darkMode', 'disabled');
                    }
                    updateExpenseCharts();
                    updateFundsCharts();
                    updateBalanceStatementChart();
                    showToast(`Dark mode ${darkMode ? 'enabled' : 'disabled'}.`, 'info');
                }

                function loadDarkModePreference() {
                    const darkModeSetting = localStorage.getItem('darkMode');
                    if (darkModeSetting === 'enabled') {
                        darkMode = true;
                        document.body.classList.add('dark-mode');
                    }
                }

                function generateSessionId() {
                    return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }

                function generateUniqueId() {
                    return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }

                // Toast Notification
                function showToast(message, type = 'info') {
                    const toastEl = document.createElement('div');
                    toastEl.className = `toast align-items-center text-bg-${type} border-0`;
                    toastEl.setAttribute('role', 'alert');
                    toastEl.setAttribute('aria-live', 'assertive');
                    toastEl.setAttribute('aria-atomic', 'true');
                    toastEl.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    `;
                    toastContainer.appendChild(toastEl);
                    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                    toast.show();
                    toastEl.addEventListener('hidden.bs.toast', () => {
                        toastEl.remove();
                    });
                }

                // Confirmation Modal
                let confirmedAction = null;
                function confirmReset(event) {
                    event.preventDefault();
                    confirmationModalBody.textContent = "Are you sure you want to reset all data? This action cannot be undone.";
                    confirmActionButton.textContent = "Reset Data";
                    confirmedAction = resetData;
                    confirmationModal.show();
                }

                function performConfirmedAction() {
                    if (typeof confirmedAction === 'function') {
                        confirmedAction();
                        confirmationModal.hide();
                        showToast('All data has been reset.', 'warning');
                    }
                }

                // Expense Categories and Subcategories
                function addCategory() {
                    const newCategory = document.getElementById('newCategory').value.trim();
                    if (newCategory && !categories.includes(newCategory)) {
                        categories.push(newCategory);
                        subcategories[newCategory] = [];
                        localStorage.setItem('categories', JSON.stringify(categories));
                        localStorage.setItem('subcategories', JSON.stringify(subcategories));
                        updateCategoryOptions();
                        updateTabs();
                        showToast('Category added successfully.', 'success');
                        document.getElementById('newCategory').value = '';
                    } else {
                        showToast('Category already exists or is invalid!', 'danger');
                    }
                }

                function addSubcategory() {
                    const category = document.getElementById('category').value;
                    const newSubcategory = document.getElementById('newSubcategory').value.trim();
                    if (category && newSubcategory) {
                        if (!subcategories[category]) {
                            subcategories[category] = [];
                        }
                        if (!subcategories[category].includes(newSubcategory)) {
                            subcategories[category].push(newSubcategory);
                            localStorage.setItem('subcategories', JSON.stringify(subcategories));
                            updateSubcategoryOptions();
                            showToast('Subcategory added successfully.', 'success');
                            document.getElementById('newSubcategory').value = '';
                        } else {
                            showToast('Subcategory already exists for this category!', 'danger');
                        }
                    } else {
                        showToast('Please select a category and enter a subcategory.', 'warning');
                    }
                }

                function updateCategoryOptions() {
                    const categorySelect = document.getElementById('category');
                    categorySelect.innerHTML = '';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                    updateSubcategoryOptions();
                    document.getElementById('category').removeEventListener('change', updateSubcategoryOptions);
                    document.getElementById('category').addEventListener('change', updateSubcategoryOptions);

                    // Update Advanced Search Category Options
                    const searchCategorySelect = document.getElementById('searchCategory');
                    searchCategorySelect.innerHTML = '<option value="">All Categories</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        searchCategorySelect.appendChild(option);
                    });
                }

                function updateSubcategoryOptions() {
                    const category = document.getElementById('category').value;
                    const subcategorySelect = document.getElementById('subcategory');
                    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                    if (subcategories[category]) {
                        subcategories[category].forEach(subcat => {
                            const option = document.createElement('option');
                            option.value = subcat;
                            option.textContent = subcat;
                            subcategorySelect.appendChild(option);
                        });
                    }

                    // Update Advanced Search Subcategory Options
                    const searchSubcategorySelect = document.getElementById('searchSubcategory');
                    searchSubcategorySelect.innerHTML = '<option value="">All Subcategories</option>';
                    if (subcategories[category]) {
                        subcategories[category].forEach(subcat => {
                            const option = document.createElement('option');
                            option.value = subcat;
                            option.textContent = subcat;
                            searchSubcategorySelect.appendChild(option);
                        });
                    }
                }

                // Funds Categories and Subcategories
                function addFundsCategory() {
                    const newCategory = document.getElementById('newFundsCategory').value.trim();
                    if (newCategory && !fundsCategories.includes(newCategory)) {
                        fundsCategories.push(newCategory);
                        fundsSubcategories[newCategory] = [];
                        localStorage.setItem('fundsCategories', JSON.stringify(fundsCategories));
                        localStorage.setItem('fundsSubcategories', JSON.stringify(fundsSubcategories));
                        updateFundsCategoryOptions();
                        updateTabs();
                        showToast('Funds category added successfully.', 'success');
                        document.getElementById('newFundsCategory').value = '';
                    } else {
                        showToast('Funds category already exists or is invalid!', 'danger');
                    }
                }

                function addFundsSubcategory() {
                    const category = document.getElementById('fundsCategory').value;
                    const newSubcategory = document.getElementById('newFundsSubcategory').value.trim();
                    if (category && newSubcategory) {
                        if (!fundsSubcategories[category]) {
                            fundsSubcategories[category] = [];
                        }
                        if (!fundsSubcategories[category].includes(newSubcategory)) {
                            fundsSubcategories[category].push(newSubcategory);
                            localStorage.setItem('fundsSubcategories', JSON.stringify(fundsSubcategories));
                            updateFundsSubcategoryOptions();
                            showToast('Funds subcategory added successfully.', 'success');
                            document.getElementById('newFundsSubcategory').value = '';
                        } else {
                            showToast('Funds subcategory already exists for this category!', 'danger');
                        }
                    } else {
                        showToast('Please select a category and enter a subcategory.', 'warning');
                    }
                }

                function updateFundsCategoryOptions() {
                    const categorySelect = document.getElementById('fundsCategory');
                    categorySelect.innerHTML = '';
                    fundsCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                    updateFundsSubcategoryOptions();
                    document.getElementById('fundsCategory').removeEventListener('change', updateFundsSubcategoryOptions);
                    document.getElementById('fundsCategory').addEventListener('change', updateFundsSubcategoryOptions);
                }

                function updateFundsSubcategoryOptions() {
                    const category = document.getElementById('fundsCategory').value;
                    const subcategorySelect = document.getElementById('fundsSubcategory');
                    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                    if (fundsSubcategories[category]) {
                        fundsSubcategories[category].forEach(subcat => {
                            const option = document.createElement('option');
                            option.value = subcat;
                            option.textContent = subcat;
                            subcategorySelect.appendChild(option);
                        });
                    }
                }

                // Update Tabs
function updateTabs() {
    const subTabContainer = document.getElementById('subTabs');
    // Remove existing category tabs
    subTabContainer.innerHTML = '';
    if (currentMainTab === 'expenseDashboard') {
        // Expense Tabs
        const categoriesTabs = ['Daily', 'Monthly', 'Yearly'].concat(categories);
        categoriesTabs.forEach(category => {
            const tab = document.createElement('li');
            tab.className = 'nav-item category-tab';
            tab.innerHTML = `<a class="nav-link" href="#" onclick="App.showSubTab('${category}', this)" role="tab">${category}</a>`;
            subTabContainer.appendChild(tab);
        });
    } else if (currentMainTab === 'fundsDashboard') {
        // Funds Tabs
        const fundsTabs = ['Daily', 'Monthly', 'Yearly'].concat(fundsCategories);
        fundsTabs.forEach(category => {
            const tab = document.createElement('li');
            tab.className = 'nav-item category-tab';
            tab.innerHTML = `<a class="nav-link" href="#" onclick="App.showSubTab('${category}', this)" role="tab">${category}</a>`;
            subTabContainer.appendChild(tab);
        });
    } else if (currentMainTab === 'balanceStatement') {
        // Balance Statement Tabs: Both Periods and Categories
        // Add Period Tabs
        const balancePeriods = ['Daily', 'Monthly', 'Yearly'];
        balancePeriods.forEach(period => {
            const tab = document.createElement('li');
            tab.className = 'nav-item category-tab';
            tab.innerHTML = `<a class="nav-link" href="#" onclick="App.showSubTab('${period}', this)" role="tab">${period}</a>`;
            subTabContainer.appendChild(tab);
        });

        // Add Expense Categories as Sub-Tabs
        categories.forEach(category => {
            const tab = document.createElement('li');
            tab.className = 'nav-item category-tab';
            tab.innerHTML = `<a class="nav-link" href="#" onclick="App.showSubTab('${category}', this)" role="tab">${category}</a>`;
            subTabContainer.appendChild(tab);
        });

        // Add Funds Categories as Sub-Tabs
        fundsCategories.forEach(category => {
            const tab = document.createElement('li');
            tab.className = 'nav-item category-tab';
            tab.innerHTML = `<a class="nav-link" href="#" onclick="App.showSubTab('${category}', this)" role="tab">${category}</a>`;
            subTabContainer.appendChild(tab);
        });
    }
}


                // Add Expense
                function addExpense() {
                    const description = document.getElementById('description').value.trim();
                    const amount = parseFloat(document.getElementById('amount').value);
                    const date = document.getElementById('date').value;
                    const category = document.getElementById('category').value;
                    const subcategory = document.getElementById('subcategory').value;

                    if (!description || isNaN(amount) || !date || !category) {
                        showToast('Please fill in all expense fields.', 'warning');
                        return;
                    }

                    const userRole = sessionStorage.getItem('userRole');
                    let expense = { description, amount, date, category, subcategory };
                    if (userRole === 'dataentry') {
                        expense.sessionId = sessionId;
                    }
                    expense.id = generateUniqueId();
                    expenses.push(expense);
                    localStorage.setItem('expenses', JSON.stringify(expenses));
                    updateExpenseSummary();
                    updateExpenseCharts();
                    updateBalanceStatementChart();
                    updateReport();
                    updateKPIValues();
                    showToast('Expense added successfully.', 'success');

                    // Clear input fields
                    document.getElementById('description').value = '';
                    document.getElementById('amount').value = '';
                    document.getElementById('date').value = '';
                }

                // Add Funds
                function addFunds() {
                    const description = document.getElementById('fundsDescription').value.trim();
                    const amount = parseFloat(document.getElementById('fundsAmount').value);
                    const date = document.getElementById('fundsDate').value;
                    const category = document.getElementById('fundsCategory').value;
                    const subcategory = document.getElementById('fundsSubcategory').value;

                    if (!description || isNaN(amount) || !date || !category) {
                        showToast('Please fill in all funds fields.', 'warning');
                        return;
                    }

                    const userRole = sessionStorage.getItem('userRole');
                    let fund = { description, amount, date, category, subcategory };
                    if (userRole === 'dataentry') {
                        fund.sessionId = sessionId;
                    }
                    fund.id = generateUniqueId();
                    funds.push(fund);
                    localStorage.setItem('funds', JSON.stringify(funds));
                    updateFundsSummary();
                    updateFundsCharts();
                    updateBalanceStatementChart();
                    updateReport();
                    updateKPIValues();
                    showToast('Funds added successfully.', 'success');

                    // Clear input fields
                    document.getElementById('fundsDescription').value = '';
                    document.getElementById('fundsAmount').value = '';
                    document.getElementById('fundsDate').value = '';
                }

                // Update Expense Summary
                function updateExpenseSummary() {
                    const totalExpenses = expenses
                        .reduce((sum, expense) => sum + expense.amount, 0);
                    document.getElementById('total').textContent = totalExpenses.toFixed(2);
                    updateNetBalance();
                }

                // Update Funds Summary
                function updateFundsSummary() {
                    const totalFunds = funds
                        .reduce((sum, fund) => sum + fund.amount, 0);
                    document.getElementById('totalFunds').textContent = totalFunds.toFixed(2);
                    updateNetBalance();
                }

                // Update Net Balance
                function updateNetBalance() {
                    const totalFunds = funds
                        .reduce((sum, fund) => sum + fund.amount, 0);
                    const totalExpenses = expenses
                        .reduce((sum, expense) => sum + expense.amount, 0);
                    const netBalance = totalFunds - totalExpenses;
                    document.getElementById('netBalance').textContent = netBalance.toFixed(2);
                }

                // Update KPI Values
                function updateKPIValues() {
                    const totalFunds = funds
                        .reduce((sum, fund) => sum + fund.amount, 0);
                    const totalExpenses = expenses
                        .reduce((sum, expense) => sum + expense.amount, 0);
                    const netBalance = totalFunds - totalExpenses;

                    document.getElementById('kpiTotalExpenses').textContent = totalExpenses.toFixed(2);
                    document.getElementById('kpiTotalFunds').textContent = totalFunds.toFixed(2);
                    document.getElementById('kpiNetBalance').textContent = netBalance.toFixed(2);
                }

                // Update Expense Charts
                function updateExpenseCharts() {
                    updateExpenseDistributionChart();
                    updateMonthlyExpensesChart();
                }

                // Update Funds Charts
                function updateFundsCharts() {
                    updateFundsDistributionChart();
                    updateMonthlyFundsChart();
                }

                // Expense Distribution Pie Chart
                function updateExpenseDistributionChart() {
                    const filteredCategories = categories; // No need to exclude 'Loan'
                    const categoryAmounts = filteredCategories.map(cat => {
                        return expenses.filter(expense => expense.category === cat)
                            .reduce((sum, expense) => sum + expense.amount, 0);
                    });

                    if (!window.expensePieChart) {
                        const ctxDistribution = document.getElementById('expenseDistribution').getContext('2d');
                        window.expensePieChart = new Chart(ctxDistribution, {
                            type: 'pie',
                            data: {
                                labels: filteredCategories,
                                datasets: [{
                                    data: categoryAmounts,
                                    backgroundColor: filteredCategories.map(() => getRandomColor()),
                                    hoverOffset: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(tooltipItem) {
                                                const total = categoryAmounts.reduce((a, b) => a + b, 0);
                                                const value = categoryAmounts[tooltipItem.dataIndex];
                                                const percentage = ((value / total) * 100).toFixed(2);
                                                return `${filteredCategories[tooltipItem.dataIndex]}: ${percentage}% (${value.toFixed(2)} Rs)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        window.expensePieChart.data.labels = filteredCategories;
                        window.expensePieChart.data.datasets[0].data = categoryAmounts;
                        window.expensePieChart.data.datasets[0].backgroundColor = filteredCategories.map(() => getRandomColor());
                        window.expensePieChart.update();
                    }
                }

                // Funds Distribution Pie Chart
                function updateFundsDistributionChart() {
                    const filteredCategories = fundsCategories; // No need to exclude 'Loan'
                    const categoryAmounts = filteredCategories.map(cat => {
                        return funds.filter(fund => fund.category === cat)
                            .reduce((sum, fund) => sum + fund.amount, 0);
                    });

                    if (!window.fundsPieChart) {
                        const ctxDistribution = document.getElementById('fundsDistribution').getContext('2d');
                        window.fundsPieChart = new Chart(ctxDistribution, {
                            type: 'pie',
                            data: {
                                labels: filteredCategories,
                                datasets: [{
                                    data: categoryAmounts,
                                    backgroundColor: filteredCategories.map(() => getRandomColor()),
                                    hoverOffset: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(tooltipItem) {
                                                const total = categoryAmounts.reduce((a, b) => a + b, 0);
                                                const value = categoryAmounts[tooltipItem.dataIndex];
                                                const percentage = ((value / total) * 100).toFixed(2);
                                                return `${filteredCategories[tooltipItem.dataIndex]}: ${percentage}% (${value.toFixed(2)} Rs)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        window.fundsPieChart.data.labels = filteredCategories;
                        window.fundsPieChart.data.datasets[0].data = categoryAmounts;
                        window.fundsPieChart.data.datasets[0].backgroundColor = filteredCategories.map(() => getRandomColor());
                        window.fundsPieChart.update();
                    }
                }

                // Monthly Expenses Bar Chart
                function updateMonthlyExpensesChart() {
                    const monthlyExpenses = {};
                    expenses.forEach(expense => {
                        const dateObj = new Date(expense.date);
                        const month = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
                        if (!monthlyExpenses[month]) monthlyExpenses[month] = {};
                        if (!monthlyExpenses[month][expense.category]) monthlyExpenses[month][expense.category] = 0;
                        monthlyExpenses[month][expense.category] += expense.amount;
                    });

                    const months = Object.keys(monthlyExpenses).sort((a, b) => new Date(a) - new Date(b));
                    const datasets = categories.map(cat => ({
                        label: cat,
                        data: months.map(month => monthlyExpenses[month][cat] || 0),
                        backgroundColor: getRandomColor()
                    }));

                    if (!window.expenseBarChart) {
                        const ctxMonthly = document.getElementById('monthlyExpensesChart').getContext('2d');
                        window.expenseBarChart = new Chart(ctxMonthly, {
                            type: 'bar',
                            data: {
                                labels: months,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        stacked: true,
                                        ticks: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    },
                                    y: {
                                        stacked: true,
                                        ticks: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        window.expenseBarChart.data.labels = months;
                        window.expenseBarChart.data.datasets = datasets;
                        window.expenseBarChart.update();
                    }
                }

                // Monthly Funds Bar Chart
                function updateMonthlyFundsChart() {
                    const monthlyFunds = {};
                    funds.forEach(fund => {
                        const dateObj = new Date(fund.date);
                        const month = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
                        if (!monthlyFunds[month]) monthlyFunds[month] = {};
                        if (!monthlyFunds[month][fund.category]) monthlyFunds[month][fund.category] = 0;
                        monthlyFunds[month][fund.category] += fund.amount;
                    });

                    const months = Object.keys(monthlyFunds).sort((a, b) => new Date(a) - new Date(b));
                    const datasets = fundsCategories.map(cat => ({
                        label: cat,
                        data: months.map(month => monthlyFunds[month][cat] || 0),
                        backgroundColor: getRandomColor()
                    }));

                    if (!window.fundsBarChart) {
                        const ctxMonthly = document.getElementById('monthlyFundsChart').getContext('2d');
                        window.fundsBarChart = new Chart(ctxMonthly, {
                            type: 'bar',
                            data: {
                                labels: months,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        stacked: true,
                                        ticks: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    },
                                    y: {
                                        stacked: true,
                                        ticks: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: darkMode ? '#e0e0e0' : '#000'
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        window.fundsBarChart.data.labels = months;
                        window.fundsBarChart.data.datasets = datasets;
                        window.fundsBarChart.update();
                    }
                }

                // Balance Statement Chart
                function updateBalanceStatementChart() {
                    const monthlyData = {};
                    // Process funds
                    funds.forEach(fund => {
                        const dateObj = new Date(fund.date);
                        const month = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
                        if (!monthlyData[month]) monthlyData[month] = { funds: 0, expenses: 0 };
                        monthlyData[month].funds += fund.amount;
                    });
                    // Process expenses
                    expenses.forEach(expense => {
                        const dateObj = new Date(expense.date);
                        const month = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
                        if (!monthlyData[month]) monthlyData[month] = { funds: 0, expenses: 0 };
                        monthlyData[month].expenses += expense.amount;
                    });

                    const months = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b));
                    const netBalanceData = months.map(month => monthlyData[month].funds - monthlyData[month].expenses);

                    if (!window.balanceStatementChartInstance) {
                        const ctx = document.getElementById('balanceStatementChart').getContext('2d');
                        window.balanceStatementChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: 'Net Balance',
                                        data: netBalanceData,
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        fill: false,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        ticks: {
                                            color: darkMode ? '#e0e0e0' : '#000',
                                        },
                                    },
                                    y: {
                                        ticks: {
                                            color: darkMode ? '#e0e0e0' : '#000',
                                        },
                                    },
                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: darkMode ? '#e0e0e0' : '#000',
                                        },
                                    },
                                },
                            },
                        });
                    } else {
                        window.balanceStatementChartInstance.data.labels = months;
                        window.balanceStatementChartInstance.data.datasets[0].data = netBalanceData;
                        window.balanceStatementChartInstance.update();
                    }
                }

                // Utility to generate random colors
                function getRandomColor() {
                    const r = Math.floor(Math.random() * 200);
                    const g = Math.floor(Math.random() * 200);
                    const b = Math.floor(Math.random() * 200);
                    return `rgba(${r}, ${g}, ${b}, 0.7)`;
                }

                // Show Main Tab
                function showMainTab(tabName, element) {
                    currentMainTab = tabName;
                    currentSubTab = '';
                    const tabs = document.querySelectorAll('#mainTabs .nav-link');
                    tabs.forEach(tab => tab.classList.remove('active'));
                    element.classList.add('active');
                    // Hide all content areas
                    document.getElementById('expenseDashboardContent').style.display = 'none';
                    document.getElementById('fundsDashboardContent').style.display = 'none';
                    document.getElementById('balanceStatementContent').style.display = 'none';
                    document.getElementById('reportContentSub').style.display = 'none';
                    document.getElementById('periodSelection').style.display = 'none';
                    document.getElementById('searchInput').value = '';
                    if (tabName === 'expenseDashboard') {
                        document.getElementById('expenseDashboardContent').style.display = 'block';
                        updateTabs();
                        updatePivotTable('Expense');
                    } else if (tabName === 'fundsDashboard') {
                        document.getElementById('fundsDashboardContent').style.display = 'block';
                        updateTabs();
                        updatePivotTable('Funds');
                    } else if (tabName === 'balanceStatement') {
                        document.getElementById('balanceStatementContent').style.display = 'block';
                        document.getElementById('periodSelection').style.display = 'flex';
                        updateBalanceStatementReport();
                    }
                }

                // Show Sub Tab
                function showSubTab(tabName, element) {
                    currentSubTab = tabName;
                    const tabs = document.querySelectorAll('#subTabs .nav-link');
                    tabs.forEach(tab => tab.classList.remove('active'));
                    element.classList.add('active');
                    document.getElementById('expenseDashboardContent').style.display = 'none';
                    document.getElementById('fundsDashboardContent').style.display = 'none';
                    document.getElementById('reportContentSub').style.display = 'block';
                    document.getElementById('periodSelection').style.display = 'flex';
                    if (currentMainTab === 'expenseDashboard') {
                        document.getElementById('reportTitleSub').textContent = `Expense Report - ${tabName}`;
                        updateExpenseReport();
                    } else if (currentMainTab === 'fundsDashboard') {
                        document.getElementById('reportTitleSub').textContent = `Funds Report - ${tabName}`;
                        updateFundsReport();
                    }
                }

                function updateReport() {
                    if (currentMainTab === 'expenseDashboard') {
                        updateExpenseReport();
                    } else if (currentMainTab === 'fundsDashboard') {
                        updateFundsReport();
                    } else if (currentMainTab === 'balanceStatement') {
                        updateBalanceStatementReport();
                    }

                    // Check if any report sections are displayed
                    const reportContent = currentSubTab ? document.getElementById('groupedReportsSub') : document.getElementById('groupedReports');
                    if (reportContent && reportContent.children.length === 0) {
                        showToast('No data matches the search criteria.', 'warning');
                    }
                }

                function updateExpenseReport() {
                    const groupedReportsDiv = document.getElementById('groupedReportsSub');
                    groupedReportsDiv.innerHTML = ''; // Clear previous content
                    let filteredEntries = expenses;

                    // Filter entries based on selected period
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate) {
                        filteredEntries = filteredEntries.filter(entry => entry.date >= startDate);
                    }
                    if (endDate) {
                        filteredEntries = filteredEntries.filter(entry => entry.date <= endDate);
                    }

                    // Filter entries based on search input
                    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
                    if (searchQuery) {
                        filteredEntries = filteredEntries.filter(entry => {
                            return (
                                (entry.description && entry.description.toLowerCase().includes(searchQuery)) ||
                                (entry.category && entry.category.toLowerCase().includes(searchQuery)) ||
                                (entry.subcategory && entry.subcategory.toLowerCase().includes(searchQuery)) ||
                                entry.date.includes(searchQuery)
                            );
                        });
                    }

                    // Advanced Search Filters
                    const advDescription = document.getElementById('searchDescription').value.toLowerCase();
                    const advCategory = document.getElementById('searchCategory').value;
                    const advSubcategory = document.getElementById('searchSubcategory').value;
                    const advAmountRange = document.getElementById('searchAmount').value;

                    if (advDescription) {
                        filteredEntries = filteredEntries.filter(entry => entry.description && entry.description.toLowerCase().includes(advDescription));
                    }
                    if (advCategory) {
                        filteredEntries = filteredEntries.filter(entry => entry.category === advCategory);
                    }
                    if (advSubcategory) {
                        filteredEntries = filteredEntries.filter(entry => entry.subcategory === advSubcategory);
                    }
                    if (advAmountRange) {
                        const [minAmount, maxAmount] = advAmountRange.split('-').map(val => parseFloat(val.trim()));
                        if (!isNaN(minAmount)) {
                            filteredEntries = filteredEntries.filter(entry => entry.amount >= minAmount);
                        }
                        if (!isNaN(maxAmount)) {
                            filteredEntries = filteredEntries.filter(entry => entry.amount <= maxAmount);
                        }
                    }

                    // Sort entries in ascending order of date
                    filteredEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

                    if (['Daily', 'Monthly', 'Yearly'].includes(currentSubTab)) {
                        groupAndDisplayEntries(filteredEntries, currentSubTab, groupedReportsDiv, 'Expense');
                    } else {
                        // Category report
                        filteredEntries = filteredEntries.filter(entry => entry.category === currentSubTab);
                        createReportSection(groupedReportsDiv, currentSubTab, filteredEntries, 'Category', 'Expense');
                    }
                }

                function updateFundsReport() {
                    const groupedReportsDiv = document.getElementById('groupedReportsSub');
                    groupedReportsDiv.innerHTML = ''; // Clear previous content
                    let filteredEntries = funds;

                    // Filter entries based on selected period
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate) {
                        filteredEntries = filteredEntries.filter(entry => entry.date >= startDate);
                    }
                    if (endDate) {
                        filteredEntries = filteredEntries.filter(entry => entry.date <= endDate);
                    }

                    // Filter entries based on search input
                    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
                    if (searchQuery) {
                        filteredEntries = filteredEntries.filter(entry => {
                            return (
                                (entry.description && entry.description.toLowerCase().includes(searchQuery)) ||
                                (entry.category && entry.category.toLowerCase().includes(searchQuery)) ||
                                (entry.subcategory && entry.subcategory.toLowerCase().includes(searchQuery)) ||
                                entry.date.includes(searchQuery)
                            );
                        });
                    }

                    // Advanced Search Filters
                    const advDescription = document.getElementById('searchDescription').value.toLowerCase();
                    const advCategory = document.getElementById('searchCategory').value;
                    const advSubcategory = document.getElementById('searchSubcategory').value;
                    const advAmountRange = document.getElementById('searchAmount').value;

                    if (advDescription) {
                        filteredEntries = filteredEntries.filter(entry => entry.description && entry.description.toLowerCase().includes(advDescription));
                    }
                    if (advCategory) {
                        filteredEntries = filteredEntries.filter(entry => entry.category === advCategory);
                    }
                    if (advSubcategory) {
                        filteredEntries = filteredEntries.filter(entry => entry.subcategory === advSubcategory);
                    }
                    if (advAmountRange) {
                        const [minAmount, maxAmount] = advAmountRange.split('-').map(val => parseFloat(val.trim()));
                        if (!isNaN(minAmount)) {
                            filteredEntries = filteredEntries.filter(entry => entry.amount >= minAmount);
                        }
                        if (!isNaN(maxAmount)) {
                            filteredEntries = filteredEntries.filter(entry => entry.amount <= maxAmount);
                        }
                    }

                    // Sort entries in ascending order of date
                    filteredEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

                    if (['Daily', 'Monthly', 'Yearly'].includes(currentSubTab)) {
                        groupAndDisplayEntries(filteredEntries, currentSubTab, groupedReportsDiv, 'Funds');
                    } else {
                        // Category report
                        filteredEntries = filteredEntries.filter(entry => entry.category === currentSubTab);
                        createReportSection(groupedReportsDiv, currentSubTab, filteredEntries, 'Category', 'Funds');
                    }
                }

                function groupAndDisplayEntries(entries, periodType, parentDiv, entryType) {
                    let groupedEntries = {};
                    let groupKey = '';
                    entries.forEach(entry => {
                        if (periodType === 'Daily') {
                            groupKey = entry.date;
                        } else if (periodType === 'Monthly') {
                            groupKey = entry.date.substring(0, 7); // YYYY-MM
                        } else if (periodType === 'Yearly') {
                            groupKey = entry.date.substring(0, 4); // YYYY
                        }
                        if (!groupedEntries[groupKey]) groupedEntries[groupKey] = [];
                        groupedEntries[groupKey].push(entry);
                    });
                    const sortedKeys = Object.keys(groupedEntries).sort((a, b) => new Date(a) - new Date(b));
                    sortedKeys.forEach(key => {
                        createReportSection(parentDiv, key, groupedEntries[key], periodType, entryType);
                    });
                }

                function createReportSection(parentDiv, groupName, entriesList, groupType, entryType) {
                    if (entriesList.length === 0) return; // Skip if no entries in the group

                    // Create heading
                    const heading = document.createElement('h3');
                    heading.textContent = `${groupType}: ${groupName}`;
                    parentDiv.appendChild(heading);

                    // Create table
                    const table = document.createElement('table');
                    table.className = 'table table-striped';
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Amount (Rs.)</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    let totalAmount = 0;
                    const userRole = sessionStorage.getItem('userRole');
                    entriesList.forEach(entry => {
                        const row = document.createElement('tr');
                        let actionButtons = '';
                        if (userRole === 'admin' || (userRole === 'dataentry' && entry.sessionId === sessionId)) {
                            actionButtons = `
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="App.deleteEntry('${entryType}', '${entry.id}')">Delete</button>
                                </td>
                            `;
                        } else {
                            actionButtons = '<td></td>';
                        }
                        row.innerHTML = `
                            <td>${entry.category}</td>
                            <td>${entry.subcategory || ''}</td>
                            <td>${entry.description}</td>
                            <td>${entry.date}</td>
                            <td>${entry.amount.toFixed(2)}</td>
                            ${actionButtons}
                        `;
                        tbody.appendChild(row);
                        totalAmount += entry.amount;
                    });
                    table.appendChild(tbody);

                    const tfoot = document.createElement('tfoot');
                    tfoot.innerHTML = `
                        <tr>
                            <th colspan="4">Total ${entryType} for ${groupType} ${groupName}</th>
                            <th>Rs. ${totalAmount.toFixed(2)}</th>
                            <th></th>
                        </tr>
                    `;
                    table.appendChild(tfoot);
                    parentDiv.appendChild(table);
                }

                function updateBalanceStatementReport() {
                    const groupedReportsDiv = document.getElementById('groupedReports');
                    groupedReportsDiv.innerHTML = ''; // Clear previous content
                    let filteredEntries = expenses.map(expense => ({ ...expense, type: 'Expense' }))
                        .concat(funds.map(fund => ({ ...fund, type: 'Funds' })));

                    // Filter entries based on selected period
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate) {
                        filteredEntries = filteredEntries.filter(entry => entry.date >= startDate);
                    }
                    if (endDate) {
                        filteredEntries = filteredEntries.filter(entry => entry.date <= endDate);
                    }

                    // Filter entries based on search input
                    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
                    if (searchQuery) {
                        filteredEntries = filteredEntries.filter(entry => {
                            return (
                                (entry.description && entry.description.toLowerCase().includes(searchQuery)) ||
                                (entry.category && entry.category.toLowerCase().includes(searchQuery)) ||
                                (entry.subcategory && entry.subcategory.toLowerCase().includes(searchQuery)) ||
                                entry.date.includes(searchQuery) ||
                                entry.type.toLowerCase().includes(searchQuery)
                            );
                        });
                    }

                    // Sort entries in ascending order of date
                    filteredEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const periodType = document.getElementById('balanceStatementPeriod').value;
                    groupAndDisplayBalanceStatementEntries(filteredEntries, groupedReportsDiv, periodType);
                }

                function groupAndDisplayBalanceStatementEntries(entries, parentDiv, periodType) {
    const groupedEntries = {};
    let groupKey = '';
    entries.forEach(entry => {
        if (periodType === 'Daily') {
            groupKey = entry.date; // Assuming 'entry.date' is in 'YYYY-MM-DD' format
        } else if (periodType === 'Monthly') {
            groupKey = entry.date.substring(0, 7); // YYYY-MM
        } else if (periodType === 'Yearly') {
            groupKey = entry.date.substring(0, 4); // YYYY
        }
        if (!groupedEntries[groupKey]) groupedEntries[groupKey] = [];
        groupedEntries[groupKey].push(entry);
    });
    const sortedKeys = Object.keys(groupedEntries).sort((a, b) => new Date(a) - new Date(b));
    sortedKeys.forEach(key => {
        createBalanceStatementSection(parentDiv, key, groupedEntries[key], periodType);
    });
}


                function createBalanceStatementSection(parentDiv, groupName, entriesList, periodType) {
                    if (entriesList.length === 0) return; // Skip if no entries in the group

                    // Create heading
                    const heading = document.createElement('h3');
                    heading.textContent = `${periodType}: ${groupName}`;
                    parentDiv.appendChild(heading);

                    // Create table
                    const table = document.createElement('table');
                    table.className = 'table table-striped';
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Amount (Rs.)</th>
                        </tr>
                    `;
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    let totalFunds = 0;
                    let totalExpenses = 0;
                    entriesList.forEach(entry => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entry.type}</td>
                            <td>${entry.category}</td>
                            <td>${entry.subcategory || ''}</td>
                            <td>${entry.description}</td>
                            <td>${entry.date}</td>
                            <td>${entry.amount.toFixed(2)}</td>
                        `;
                        tbody.appendChild(row);
                        if (entry.type === 'Funds') {
                            totalFunds += entry.amount;
                        } else if (entry.type === 'Expense') {
                            totalExpenses += entry.amount;
                        }
                    });
                    table.appendChild(tbody);

                    const tfoot = document.createElement('tfoot');
                    const netTotal = totalFunds - totalExpenses;
                    tfoot.innerHTML = `
                        <tr>
                            <th colspan="4">Total Funds for ${periodType} ${groupName}</th>
                            <th>Rs. ${totalFunds.toFixed(2)}</th>
                            <th></th>
                        </tr>
                        <tr>
                            <th colspan="4">Total Expenses for ${periodType} ${groupName}</th>
                            <th>Rs. ${totalExpenses.toFixed(2)}</th>
                            <th></th>
                        </tr>
                        <tr>
                            <th colspan="4">Net Total for ${periodType} ${groupName}</th>
                            <th>Rs. ${netTotal.toFixed(2)}</th>
                            <th></th>
                        </tr>
                    `;
                    table.appendChild(tfoot);
                    parentDiv.appendChild(table);
                }

                function deleteEntry(entryType, id) {
                    const userRole = sessionStorage.getItem('userRole');
                    if (entryType === 'Expense') {
                        const index = expenses.findIndex(expense => expense.id === id);
                        if (index !== -1) {
                            if (userRole === 'dataentry' && expenses[index].sessionId !== sessionId) {
                                showToast('You can only delete your own entries.', 'danger');
                                return;
                            }
                            expenses.splice(index, 1);
                            localStorage.setItem('expenses', JSON.stringify(expenses));
                            updateExpenseSummary();
                            updateExpenseCharts();
                            updateBalanceStatementChart();
                            updateReport();
                            updateKPIValues();
                            showToast('Expense deleted successfully.', 'success');
                        }
                    } else if (entryType === 'Funds') {
                        const index = funds.findIndex(fund => fund.id === id);
                        if (index !== -1) {
                            if (userRole === 'dataentry' && funds[index].sessionId !== sessionId) {
                                showToast('You can only delete your own entries.', 'danger');
                                return;
                            }
                            funds.splice(index, 1);
                            localStorage.setItem('funds', JSON.stringify(funds));
                            updateFundsSummary();
                            updateFundsCharts();
                            updateBalanceStatementChart();
                            updateReport();
                            updateKPIValues();
                            showToast('Funds deleted successfully.', 'success');
                        }
                    }
                }

                // Generate PDF for Balance Statement Report
                function generatePDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const reportTitle = document.getElementById('reportTitle').textContent;
                    const groupedReportsDiv = document.getElementById('groupedReports');

                    // Add system name and title
                    doc.setFontSize(18);
                    doc.text('SIS Construction Management System', 14, 20);
                    doc.setFontSize(16);
                    doc.text(reportTitle, 14, 30);

                    // Add date range if applicable
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate || endDate) {
                        doc.setFontSize(12);
                        doc.text(`Date Range: ${startDate || 'N/A'} to ${endDate || 'N/A'}`, 14, 38);
                    }

                    let yPosition = 46;

                    const sections = groupedReportsDiv.children;
                    for (let i = 0; i < sections.length; i += 2) {
                        const heading = sections[i].textContent;
                        const table = sections[i + 1];

                        doc.setFontSize(14);
                        doc.text(heading, 14, yPosition);
                        yPosition += 6;

                        // Extract table data
                        const tableData = [];
                        const headers = [];
                        const tableRows = table.querySelectorAll('tr');

                        tableRows.forEach((row, index) => {
                            const rowData = [];
                            row.querySelectorAll('th:not(:last-child), td:not(:last-child)').forEach(cell => {
                                rowData.push(cell.innerText);
                            });
                            if (index === 0) {
                                headers.push(...rowData);
                            } else {
                                tableData.push(rowData);
                            }
                        });

                        doc.autoTable({
                            startY: yPosition,
                            head: [headers],
                            body: tableData,
                            theme: 'grid',
                            headStyles: { fillColor: [41, 128, 185] },
                            styles: { fontSize: 10 },
                            margin: { left: 14, right: 14 },
                        });

                        yPosition = doc.previousAutoTable.finalY + 10;

                        // Add new page if necessary
                        if (yPosition > 270 && i + 2 < sections.length) {
                            doc.addPage();
                            yPosition = 20;
                        }
                    }

                    doc.save('Balance_Statement_Report.pdf');
                }

                // Generate PDF for Sub Reports (Expense or Funds)
                function generatePDFSub() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const reportTitle = document.getElementById('reportTitleSub').textContent;
                    const groupedReportsDiv = document.getElementById('groupedReportsSub');

                    // Add system name and title
                    doc.setFontSize(18);
                    doc.text('SIS Construction Management System', 14, 20);
                    doc.setFontSize(16);
                    doc.text(reportTitle, 14, 30);

                    // Add date range if applicable
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate || endDate) {
                        doc.setFontSize(12);
                        doc.text(`Date Range: ${startDate || 'N/A'} to ${endDate || 'N/A'}`, 14, 38);
                    }

                    let yPosition = 46;

                    const sections = groupedReportsDiv.children;
                    for (let i = 0; i < sections.length; i += 2) {
                        const heading = sections[i].textContent;
                        const table = sections[i + 1];

                        doc.setFontSize(14);
                        doc.text(heading, 14, yPosition);
                        yPosition += 6;

                        // Extract table data
                        const tableData = [];
                        const headers = [];
                        const tableRows = table.querySelectorAll('tr');

                        tableRows.forEach((row, index) => {
                            const rowData = [];
                            row.querySelectorAll('th:not(:last-child), td:not(:last-child)').forEach(cell => {
                                rowData.push(cell.innerText);
                            });
                            if (index === 0) {
                                headers.push(...rowData);
                            } else {
                                tableData.push(rowData);
                            }
                        });

                        doc.autoTable({
                            startY: yPosition,
                            head: [headers],
                            body: tableData,
                            theme: 'grid',
                            headStyles: { fillColor: [41, 128, 185] },
                            styles: { fontSize: 10 },
                            margin: { left: 14, right: 14 },
                        });

                        yPosition = doc.previousAutoTable.finalY + 10;

                        // Add new page if necessary
                        if (yPosition > 270 && i + 2 < sections.length) {
                            doc.addPage();
                            yPosition = 20;
                        }
                    }

                    const fileName = reportTitle.replace(/\s+/g, '_') + '.pdf';
                    doc.save(fileName);
                }

                // Export Expenses to Excel
                function exportExpensesToExcel() {
                    const userRole = sessionStorage.getItem('userRole');
                    let dataToExport = expenses;

                    if (userRole === 'dataentry') {
                        dataToExport = expenses.filter(expense => expense.sessionId === sessionId);
                    }

                    const wsExpenses = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, wsExpenses, "Expenses");
                    XLSX.writeFile(wb, "expenses.xlsx");
                    showToast('Expenses exported to Excel successfully.', 'success');
                }

                // Export Funds to Excel
                function exportFundsToExcel() {
                    const userRole = sessionStorage.getItem('userRole');
                    let dataToExport = funds;

                    if (userRole === 'dataentry') {
                        dataToExport = funds.filter(fund => fund.sessionId === sessionId);
                    }

                    const wsFunds = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, wsFunds, "Funds");
                    XLSX.writeFile(wb, "funds.xlsx");
                    showToast('Funds exported to Excel successfully.', 'success');
                }

                // Import Expenses from Excel
                function importFromExcel(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });

                            // Import Expenses
                            const expenseSheet = workbook.Sheets["Expenses"];
                            if (expenseSheet) {
                                const importedExpenses = XLSX.utils.sheet_to_json(expenseSheet);

                                // Process imported expenses
                                let successCount = 0;
                                let duplicateCount = 0;
                                importedExpenses.forEach(exp => {
                                    if (typeof exp.date === 'number') {
                                        exp.date = excelDateToJSDate(exp.date);
                                    }
                                    exp.amount = parseFloat(exp.amount);
                                    if (!categories.includes(exp.category)) {
                                        categories.push(exp.category);
                                    }
                                    if (exp.subcategory) {
                                        if (!subcategories[exp.category]) {
                                            subcategories[exp.category] = [];
                                        }
                                        if (!subcategories[exp.category].includes(exp.subcategory)) {
                                            subcategories[exp.category].push(exp.subcategory);
                                        }
                                    }
                                    if (!exp.id) {
                                        exp.id = generateUniqueId();
                                    }
                                    // Check for duplicates based on unique ID
                                    if (!expenses.some(existing => existing.id === exp.id)) {
                                        expenses.push(exp);
                                        successCount++;
                                    } else {
                                        duplicateCount++;
                                    }
                                });

                                localStorage.setItem('expenses', JSON.stringify(expenses));
                                localStorage.setItem('categories', JSON.stringify(categories));
                                localStorage.setItem('subcategories', JSON.stringify(subcategories));

                                updateCategoryOptions();
                                updateTabs();
                                updateExpenseSummary();
                                updateExpenseCharts();
                                updateBalanceStatementChart();
                                updateReport();
                                updateKPIValues();
                                showToast(`${successCount} expenses imported successfully. ${duplicateCount} duplicates were skipped.`, 'success');
                            } else {
                                showToast("No 'Expenses' sheet found in the Excel file.", 'danger');
                            }
                        };
                        reader.readAsBinaryString(file);
                    }
                }

                // Import Funds from Excel
                function importFundsFromExcel(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });

                            // Import Funds
                            const fundsSheet = workbook.Sheets["Funds"];
                            if (fundsSheet) {
                                const importedFunds = XLSX.utils.sheet_to_json(fundsSheet);

                                // Process imported funds
                                let successCount = 0;
                                let duplicateCount = 0;
                                importedFunds.forEach(fund => {
                                    if (typeof fund.date === 'number') {
                                        fund.date = excelDateToJSDate(fund.date);
                                    }
                                    fund.amount = parseFloat(fund.amount);
                                    if (!fundsCategories.includes(fund.category)) {
                                        fundsCategories.push(fund.category);
                                    }
                                    if (fund.subcategory) {
                                        if (!fundsSubcategories[fund.category]) {
                                            fundsSubcategories[fund.category] = [];
                                        }
                                        if (!fundsSubcategories[fund.category].includes(fund.subcategory)) {
                                            fundsSubcategories[fund.category].push(fund.subcategory);
                                        }
                                    }
                                    if (!fund.id) {
                                        fund.id = generateUniqueId();
                                    }
                                    // Check for duplicates based on unique ID
                                    if (!funds.some(existing => existing.id === fund.id)) {
                                        funds.push(fund);
                                        successCount++;
                                    } else {
                                        duplicateCount++;
                                    }
                                });

                                localStorage.setItem('funds', JSON.stringify(funds));
                                localStorage.setItem('fundsCategories', JSON.stringify(fundsCategories));
                                localStorage.setItem('fundsSubcategories', JSON.stringify(fundsSubcategories));

                                updateFundsCategoryOptions();
                                updateTabs();
                                updateFundsSummary();
                                updateFundsCharts();
                                updateBalanceStatementChart();
                                updateReport();
                                updateKPIValues();
                                showToast(`${successCount} funds imported successfully. ${duplicateCount} duplicates were skipped.`, 'success');
                            } else {
                                showToast("No 'Funds' sheet found in the Excel file.", 'danger');
                            }
                        };
                        reader.readAsBinaryString(file);
                    }
                }

                // Utility to convert Excel date serial to JS date
                function excelDateToJSDate(serial) {
                    const utc_days  = Math.floor(serial - 25569);
                    const utc_value = utc_days * 86400;                                        
                    const date_info = new Date(utc_value * 1000);

                    const fractional_day = serial - Math.floor(serial) + 0.0000001;

                    let total_seconds = Math.floor(86400 * fractional_day);

                    const seconds = total_seconds % 60;
                    total_seconds -= seconds;

                    const hours = Math.floor(total_seconds / (60 * 60));
                    const minutes = Math.floor(total_seconds / 60) % 60;

                    return `${date_info.getFullYear()}-${String(date_info.getMonth()+1).padStart(2, '0')}-${String(date_info.getDate()).padStart(2, '0')}`;
                }

                // Reset Data Function
                function resetData() {
                    localStorage.clear();
                    expenses = [];
                    categories = [
                        'Bricks', 'Sand', 'Crush', 'Steel', 'Cenemt', 'Gravel',
                        'Bajjar', 'Labour', 'Contractor', 'Electrical', 'Plumbing',
                        'Hardwear items', 'Paint', 'Consultant fee', 'Fule',
                        'Tiles', 'Windows and doors', 'Plantation', 'Loans Out', 'Misleanious'
                    ];
                    subcategories = {};
                    funds = [];
                    fundsCategories = [
                        'Loans Paidback', 'Gift', 'Seed money'
                    ];
                    fundsSubcategories = {};
                    users = [
                        { username: 'admin', password: 'password123', role: 'admin' },
                        { username: 'dataentry', password: 'data123', role: 'dataentry' }
                    ];
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('categories', JSON.stringify(categories));
                    localStorage.setItem('subcategories', JSON.stringify(subcategories));
                    localStorage.setItem('fundsCategories', JSON.stringify(fundsCategories));
                    localStorage.setItem('fundsSubcategories', JSON.stringify(fundsSubcategories));
                    updateCategoryOptions();
                    updateFundsCategoryOptions();
                    updateTabs();
                    updateExpenseSummary();
                    updateFundsSummary();
                    updateExpenseCharts();
                    updateFundsCharts();
                    updateBalanceStatementChart();
                    updateReport();
                    updateKPIValues();
                    showToast('All data has been reset.', 'warning');
                }

                // Backup Database Function
                function backupDatabase() {
                    const wsExpenses = XLSX.utils.json_to_sheet(expenses);
                    const wsFunds = XLSX.utils.json_to_sheet(funds);
                    const wsUsers = XLSX.utils.json_to_sheet(users);

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, wsExpenses, "Expenses");
                    XLSX.utils.book_append_sheet(wb, wsFunds, "Funds");
                    XLSX.utils.book_append_sheet(wb, wsUsers, "Users");

                    XLSX.writeFile(wb, "database_backup.xlsx");
                    showToast('Database backup created successfully.', 'success');
                }

                // Restore Database Function
                function restoreDatabase(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });

                            // Restore Expenses
                            const expenseSheet = workbook.Sheets["Expenses"];
                            if (expenseSheet) {
                                const restoredExpenses = XLSX.utils.sheet_to_json(expenseSheet);
                                restoredExpenses.forEach(exp => {
                                    if (typeof exp.date === 'number') {
                                        exp.date = excelDateToJSDate(exp.date);
                                    }
                                    exp.amount = parseFloat(exp.amount);
                                    if (!exp.id) {
                                        exp.id = generateUniqueId();
                                    }
                                });
                                expenses = restoredExpenses;
                                localStorage.setItem('expenses', JSON.stringify(expenses));
                            } else {
                                showToast("No 'Expenses' sheet found in the backup file.", 'danger');
                                return;
                            }

                            // Restore Funds
                            const fundsSheet = workbook.Sheets["Funds"];
                            if (fundsSheet) {
                                const restoredFunds = XLSX.utils.sheet_to_json(fundsSheet);
                                restoredFunds.forEach(fund => {
                                    if (typeof fund.date === 'number') {
                                        fund.date = excelDateToJSDate(fund.date);
                                    }
                                    fund.amount = parseFloat(fund.amount);
                                    if (!fund.id) {
                                        fund.id = generateUniqueId();
                                    }
                                });
                                funds = restoredFunds;
                                localStorage.setItem('funds', JSON.stringify(funds));
                            } else {
                                showToast("No 'Funds' sheet found in the backup file.", 'danger');
                                return;
                            }

                            // Restore Users
                            const usersSheet = workbook.Sheets["Users"];
                            if (usersSheet) {
                                const restoredUsers = XLSX.utils.sheet_to_json(usersSheet);
                                users = restoredUsers;
                                localStorage.setItem('users', JSON.stringify(users));
                            } else {
                                showToast("No 'Users' sheet found in the backup file.", 'danger');
                                return;
                            }

                            // Restore Categories and Subcategories
                            categories = [...new Set(expenses.map(exp => exp.category))];
                            subcategories = {};
                            expenses.forEach(exp => {
                                if (exp.subcategory) {
                                    if (!subcategories[exp.category]) {
                                        subcategories[exp.category] = [];
                                    }
                                    if (!subcategories[exp.category].includes(exp.subcategory)) {
                                        subcategories[exp.category].push(exp.subcategory);
                                    }
                                }
                            });
                            fundsCategories = [...new Set(funds.map(fund => fund.category))];
                            fundsSubcategories = {};
                            funds.forEach(fund => {
                                if (fund.subcategory) {
                                    if (!fundsSubcategories[fund.category]) {
                                        fundsSubcategories[fund.category] = [];
                                    }
                                    if (!fundsSubcategories[fund.category].includes(fund.subcategory)) {
                                        fundsSubcategories[fund.category].push(fund.subcategory);
                                    }
                                }
                            });
                            localStorage.setItem('categories', JSON.stringify(categories));
                            localStorage.setItem('subcategories', JSON.stringify(subcategories));
                            localStorage.setItem('fundsCategories', JSON.stringify(fundsCategories));
                            localStorage.setItem('fundsSubcategories', JSON.stringify(fundsSubcategories));
                            localStorage.setItem('users', JSON.stringify(users));

                            // Update the UI
                            updateCategoryOptions();
                            updateFundsCategoryOptions();
                            updateTabs();
                            updateExpenseSummary();
                            updateFundsSummary();
                            updateExpenseCharts();
                            updateFundsCharts();
                            updateBalanceStatementChart();
                            updateReport();
                            updateKPIValues();

                            showToast("Database restored successfully!", 'success');
                        };
                        reader.readAsBinaryString(file);
                    }
                }

                // Toggle Advanced Search
                function toggleAdvancedSearch() {
                    if (advancedSearchDiv.style.display === 'none' || advancedSearchDiv.style.display === '') {
                        advancedSearchDiv.style.display = 'block';
                    } else {
                        advancedSearchDiv.style.display = 'none';
                    }
                }

                // Populate Advanced Search Options
                function populateAdvancedSearchOptions() {
                    const searchCategorySelect = document.getElementById('searchCategory');
                    searchCategorySelect.innerHTML = '<option value="">All Categories</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        searchCategorySelect.appendChild(option);
                    });

                    const searchSubcategorySelect = document.getElementById('searchSubcategory');
                    searchSubcategorySelect.innerHTML = '<option value="">All Subcategories</option>';
                    categories.forEach(category => {
                        if (subcategories[category]) {
                            subcategories[category].forEach(subcat => {
                                const option = document.createElement('option');
                                option.value = subcat;
                                option.textContent = subcat;
                                searchSubcategorySelect.appendChild(option);
                            });
                        }
                    });
                }

                // Perform Advanced Search
                function performAdvancedSearch() {
                    updateReport();
                }

                // Set Quick Select Period
                function setQuickSelectPeriod(period) {
                    const today = new Date();
                    let startDate, endDate;

                    switch(period) {
                        case 'today':
                            startDate = formatDate(today);
                            endDate = formatDate(today);
                            break;
                        case 'thisWeek':
                            const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
                            const lastDay = new Date(firstDay);
                            lastDay.setDate(lastDay.getDate() + 6);
                            startDate = formatDate(firstDay);
                            endDate = formatDate(lastDay);
                            break;
                        case 'thisMonth':
                            startDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2, '0')}-01`;
                            endDate = formatDate(new Date(today.getFullYear(), today.getMonth()+1, 0));
                            break;
                        case 'lastMonth':
                            const lastMonth = new Date(today.getFullYear(), today.getMonth()-1, 1);
                            startDate = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth()+1).padStart(2, '0')}-01`;
                            endDate = formatDate(new Date(lastMonth.getFullYear(), lastMonth.getMonth()+1, 0));
                            break;
                        case 'thisYear':
                            startDate = `${today.getFullYear()}-01-01`;
                            endDate = `${today.getFullYear()}-12-31`;
                            break;
                        default:
                            startDate = '';
                            endDate = '';
                    }

                    document.getElementById('startDate').value = startDate;
                    document.getElementById('endDate').value = endDate;
                    updateReport();
                }

                // Utility to format date to YYYY-MM-DD
                function formatDate(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth()+1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                // Pivot Table Functionality
                function updatePivotTable(entryType) {
                    const pivotContainerId = entryType === 'Expense' ? 'expensePivotTable' : 'fundsPivotTable';
                    const pivotContainer = document.getElementById(pivotContainerId);
                    pivotContainer.innerHTML = ''; // Clear previous pivot table

                    const data = entryType === 'Expense' ? expenses : funds;

                    // Create a table element for pivot
                    const table = document.createElement('table');
                    pivotContainer.appendChild(table);

                    $(table).pivotUI(
                        data,
                        {
                            rows: ["category"],
                            cols: ["subcategory"],
                            aggregatorName: "Sum",
                            vals: ["amount"],
                            rendererName: "Table"
                        }
                    );
                }

                // Interactive Charts EnhanCenemts
                // You can enhance the existing charts by adding interactivity features as needed.
                // For example, adding click events to filter data based on chart segments.

                // Performance Optimization: Pagination Example
                function paginateTable(tableId, rowsPerPage) {
                    const table = document.getElementById(tableId);
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const totalPages = Math.ceil(rows.length / rowsPerPage);
                    let currentPage = 1;

                    function displayPage(page) {
                        tbody.innerHTML = '';
                        const start = (page - 1) * rowsPerPage;
                        const end = start + rowsPerPage;
                        rows.slice(start, end).forEach(row => tbody.appendChild(row));
                    }

                    // Create pagination controls
                    const pagination = document.createElement('div');
                    pagination.className = 'd-flex justify-content-center mt-3';
                    for (let i = 1; i <= totalPages; i++) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-primary mx-1';
                        btn.textContent = i;
                        btn.addEventListener('click', () => {
                            currentPage = i;
                            displayPage(currentPage);
                        });
                        pagination.appendChild(btn);
                    }
                    table.parentNode.appendChild(pagination);

                    displayPage(currentPage);
                }

                // User-Friendly Messages and Guidance
                // Example: Display warning when no data matches search criteria
                function updateReport() {
                    if (currentMainTab === 'expenseDashboard') {
                        updateExpenseReport();
                    } else if (currentMainTab === 'fundsDashboard') {
                        updateFundsReport();
                    } else if (currentMainTab === 'balanceStatement') {
                        updateBalanceStatementReport();
                    }

                    // Check if any report sections are displayed
                    const reportContent = currentSubTab ? document.getElementById('groupedReportsSub') : document.getElementById('groupedReports');
                    if (reportContent && reportContent.children.length === 0) {
                        showToast('No data matches the search criteria.', 'warning');
                    }
                }

                // Populate Advanced Search Options on Initialize
                function populateAdvancedSearchOptions() {
                    const searchCategorySelect = document.getElementById('searchCategory');
                    searchCategorySelect.innerHTML = '<option value="">All Categories</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        searchCategorySelect.appendChild(option);
                    });

                    const searchSubcategorySelect = document.getElementById('searchSubcategory');
                    searchSubcategorySelect.innerHTML = '<option value="">All Subcategories</option>';
                    categories.forEach(category => {
                        if (subcategories[category]) {
                            subcategories[category].forEach(subcat => {
                                const option = document.createElement('option');
                                option.value = subcat;
                                option.textContent = subcat;
                                searchSubcategorySelect.appendChild(option);
                            });
                        }
                    });
                }

                // Toggle Dashboard Customization (Placeholder for Drag-and-Drop Implementation)
                function customizeDashboard() {
                    // Implement drag-and-drop functionality for dashboard components
                    // This is a placeholder function
                    showToast('Dashboard customization feature coming soon!', 'info');
                }

                // Personalization and Settings
                // Already handled by other functions

                // Inline Editing of Entries (Example for Expenses)
                function enableInlineEditing(entryType, id) {
                    let entry;
                    if (entryType === 'Expense') {
                        entry = expenses.find(exp => exp.id === id);
                    } else if (entryType === 'Funds') {
                        entry = funds.find(fund => fund.id === id);
                    }

                    if (entry) {
                        // Implement inline editing logic
                        // This is a placeholder function
                        showToast('Inline editing feature coming soon!', 'info');
                    }
                }

                // Password Reset Functions
                function openPasswordResetModal() {
                    resetUsernameSelect.innerHTML = '';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = user.username;
                        resetUsernameSelect.appendChild(option);
                    });
                    passwordResetModal.show();
                }

                function handlePasswordReset() {
                    const selectedUsername = resetUsernameSelect.value;
                    const newPassword = newPasswordInput.value.trim();
                    const confirmPassword = confirmPasswordInput.value.trim();

                    if (!selectedUsername || !newPassword || !confirmPassword) {
                        showToast('Please fill in all password reset fields.', 'warning');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        showToast('Passwords do not match.', 'danger');
                        return;
                    }

                    const userIndex = users.findIndex(u => u.username === selectedUsername);
                    if (userIndex !== -1) {
                        users[userIndex].password = newPassword;
                        localStorage.setItem('users', JSON.stringify(users));
                        showToast('Password reset successfully.', 'success');
                        passwordResetModal.hide();
                        // Clear password fields
                        newPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                    } else {
                        showToast('Selected user does not exist.', 'danger');
                    }
                }

                // Return public methods
                return {
                    showMainTab,
                    showSubTab,
                    updateReport,
                    deleteEntry,
                    generatePDF,
                    generatePDFSub,
                    exportExpensesToExcel,
                    exportFundsToExcel,
                    importFromExcel,
                    importFundsFromExcel,
                    backupDatabase,
                    restoreDatabase,
                    confirmReset,
                    toggleDarkMode,
                    showToast,
                    setQuickSelectPeriod,
                    updatePivotTable
                };
            })();
        </script>
    </body>
    </html>
            <!-- Closing the mainContent div and other necessary HTML elements -->
        </div> <!-- End of mainContent -->

        <!-- Additional Scripts if needed -->
        <script>
            // Ensure that 'Loan' and related categories are completely removed

            // Update the default categories by removing 'Loans Out' and any other 'Loan' related entries
            (function removeLoanCategory() {
                // Remove 'Loans Out' from expense categories if present
                const loanCategoryIndex = categories.indexOf('Loans Out');
                if (loanCategoryIndex !== -1) {
                    categories.splice(loanCategoryIndex, 1);
                }

                // Similarly, remove 'Loans Paidback' from funds categories
                const loanFundsCategoryIndex = fundsCategories.indexOf('Loans Paidback');
                if (loanFundsCategoryIndex !== -1) {
                    fundsCategories.splice(loanFundsCategoryIndex, 1);
                }

                // Update localStorage with the updated categories
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('fundsCategories', JSON.stringify(fundsCategories));

                // Remove subcategories related to 'Loan' if any
                delete subcategories['Loans Out'];
                delete fundsSubcategories['Loans Paidback'];
                localStorage.setItem('subcategories', JSON.stringify(subcategories));
                localStorage.setItem('fundsSubcategories', JSON.stringify(fundsSubcategories));

                // Update the UI to reflect the changes
                App.updateCategoryOptions();
                App.updateFundsCategoryOptions();
                App.updateTabs();
                App.updateExpenseSummary();
                App.updateFundsSummary();
                App.updateExpenseCharts();
                App.updateFundsCharts();
                App.updateBalanceStatementChart();
                App.updateReport();
                App.updateKPIValues();

                App.showToast('Default "Loan" category has been removed.', 'info');
            })();

            // Modify the resetData function to exclude 'Loan' related categories
            (function modifyResetData() {
                const originalResetData = App.resetData;
                App.resetData = function() {
                    originalResetData();

                    // After reset, ensure 'Loan' categories are not re-added
                    // Since originalResetData sets default categories, override them here

                    categories = [
                        'Bricks', 'Sand', 'Crush', 'Steel', 'Cenemt', 'Gravel',
                        'Bajjar', 'Labour', 'Contractor', 'Electrical', 'Plumbing',
                        'Hardwear items', 'Paint', 'Consultant fee', 'Fule',
                        'Tiles', 'Windows and doors', 'Plantation', 'Misleanious'
                    ];
                    subcategories = {};
                    fundsCategories = [
                        'Gift', 'Seed money'
                    ];
                    fundsSubcategories = {};

                    localStorage.setItem('categories', JSON.stringify(categories));
                    localStorage.setItem('subcategories', JSON.stringify(subcategories));
                    localStorage.setItem('fundsCategories', JSON.stringify(fundsCategories));
                    localStorage.setItem('fundsSubcategories', JSON.stringify(fundsSubcategories));

                    App.updateCategoryOptions();
                    App.updateFundsCategoryOptions();
                    App.updateTabs();
                    App.updateExpenseSummary();
                    App.updateFundsSummary();
                    App.updateExpenseCharts();
                    App.updateFundsCharts();
                    App.updateBalanceStatementChart();
                    App.updateReport();
                    App.updateKPIValues();

                    App.showToast('All data has been reset, excluding "Loan" categories.', 'warning');
                };
            })();

            // Ensure that any new entries cannot use the removed 'Loan' categories
            (function enforceCategoryExclusion() {
                // Override the addExpense function to prevent adding 'Loan' category
                const originalAddExpense = App.addExpense;
                App.addExpense = function() {
                    const category = document.getElementById('category').value;
                    if (category.toLowerCase().includes('loan')) {
                        App.showToast('Adding entries under "Loan" category is not allowed.', 'danger');
                        return;
                    }
                    originalAddExpense();
                };

                // Similarly, override the addFunds function
                const originalAddFunds = App.addFunds;
                App.addFunds = function() {
                    const category = document.getElementById('fundsCategory').value;
                    if (category.toLowerCase().includes('loan')) {
                        App.showToast('Adding entries under "Loan" category is not allowed.', 'danger');
                        return;
                    }
                    originalAddFunds();
                };
            })();

            // Close any remaining HTML tags if necessary
            // (Already handled in previous parts)

        </script>
    </body>
    </html>
